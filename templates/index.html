<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Filesystem Chat (Dark)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js" integrity="sha512-Jv3WSoOsAU28h7Fh73j7vLdC5hKd7ehhMng8yOczP2h7K31wYf/6r5hF0y/Nn23lHHZEDGJHjXhD+0+Q+Q5jNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* Dark Theme Base */
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #1e1e1e; /* Dark background */
            color: #e0e0e0; /* Light text */
        }

        h1 {
            color: #f8f9fa; /* Lighter heading */
            border-bottom: 1px solid #444; /* Darker border */
            padding-bottom: 10px;
        }

        .chatbox {
            background-color: #2a2a2a; /* Slightly lighter dark background */
            border: 1px solid #444; /* Darker border */
            padding: 15px;
            height: 60vh;
            overflow-y: scroll; /* Keep scroll enabled */
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Message Styling */
        .user-message {
            background-color: #0a4a7e; /* Darker blue for user */
            color: #ffffff;
            margin-left: auto; /* Align user messages to the right */
            text-align: right;
        }

        .model-message {
            background-color: #3a3a3a; /* Dark grey for model */
            color: #e0e0e0;
            margin-right: auto; /* Ensure model messages stay left */
            white-space: normal; /* Allow wrapping from Markdown */
        }
        /* --- Styling for Markdown elements within model messages --- */
        .model-message > div { /* Target the div created by JS to hold markdown content */
             margin-top: 5px; /* Add space below "Gemini:" */
        }

        /* Inline code */
        .model-message code:not(pre code) { /* Style inline code differently from code blocks */
            background-color: #222; /* Slightly different dark */
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            border: 1px solid #444;
        }

        /* Code blocks */
        .model-message pre {
            background-color: #1c1c1c; /* Very dark background for code blocks */
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto; /* Allow horizontal scroll for long code blocks */
            border: 1px solid #444;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .model-message pre code { /* Target code specifically within pre */
            background-color: transparent; /* Inherit pre background */
            padding: 0;
            border: none;
            font-family: monospace; /* Ensure monospace */
            font-size: 0.9em; /* Consistent font size */
            white-space: pre; /* Preserve whitespace in code block */
            color: #abb2bf; /* Default text color from atom-one-dark theme */
        }
        /* Override highlight.js default background if needed, but atom-one-dark should match pre */
        .model-message pre code.hljs {
             background: transparent !important;
             padding: 0 !important; /* Override hljs padding */
        }

        .model-message ul, .model-message ol {
             padding-left: 25px; /* More indentation for lists */
             margin-top: 5px;
             margin-bottom: 5px;
        }
         .model-message li {
             margin-bottom: 4px; /* Space between list items */
         }

        .model-message blockquote {
            border-left: 3px solid #555;
            padding-left: 15px; /* More padding */
            margin-left: 0;
            margin-top: 5px;
            margin-bottom: 5px;
            color: #aaa;
            font-style: italic;
        }
        .model-message table {
            border-collapse: collapse;
            margin: 10px 0;
            width: auto; /* Don't force full width */
            border: 1px solid #555;
        }
        .model-message th, .model-message td {
            border: 1px solid #555;
            padding: 6px 10px;
            text-align: left;
        }
         .model-message th {
             background-color: #333;
             font-weight: bold;
         }
         /* --- End Markdown Styling --- */


        .error-message {
            background-color: #5e2a2e; /* Dark red for errors */
            color: #f8d7da;
            margin-right: auto;
            white-space: pre-wrap;
        }

         .internal-message {
            background-color: #4d431f; /* Dark yellow for internal steps */
            color: #fff3cd;
            font-size: 0.8em;
            font-style: italic;
            margin-left: auto;
            margin-right: auto;
            max-width: 90%;
            margin-top: 5px;
            margin-bottom: 5px;
            white-space: pre-wrap;
            border: 1px dashed #665d3e;
            text-align: center;
        }

        /* Form Styling */
        form {
            display: flex;
            margin-top: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 3px;
            margin-right: 10px;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1em;
        }
        input[type="text"]::placeholder {
             color: #888;
        }


        button {
            padding: 10px 15px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0b5ed7;
        }

        /* Link Buttons */
        .button-link {
            display: inline-block;
            padding: 5px 10px;
            margin-top: 10px;
            margin-right: 10px;
            background-color: #495057;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .button-link:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <h1>Chat with Filesystem MCP Server (Dark)</h1>
    <div class="chatbox" id="chatbox">
        {% for msg in chat_history %}
            {% if msg.type == 'user' %}
                <div class="message user-message"><b>You:</b> {{ msg.text }}</div>
            {% elif msg.type == 'model' %}
                {# Add data attribute for raw markdown, remove |safe filter from initial display #}
                <div class="message model-message" data-markdown-content="{{ msg.text }}">
                    <b>Gemini:</b><br>
                    {# Initial content is HTML-escaped text, will be replaced by JS #}
                    <span class="raw-model-content" style="white-space: pre-wrap;">{{ msg.text }}</span>
                </div>
            {% elif msg.type == 'error' %}
                <div class="message error-message"><b>Error:</b><br>{{ msg.text }}</div>
            {% elif msg.type == 'internal' %}
                 <div class="message internal-message"><i>{{ msg.text }}</i></div>
            {% endif %}
        {% endfor %}
    </div>

    <form method="post" action="/chat">
        <input type="text" name="prompt" placeholder="Enter your message..." required autocomplete="off">
        <button type="submit">Send</button>
    </form>
    <a href="/reset" class="button-link">Reset Chat</a>
    <a href="/debug" class="button-link" target="_blank">View Debug Log</a>

    <script>
        // Function to scroll the chatbox to the bottom
        function scrollToBottom() {
            const chatbox = document.getElementById('chatbox');
            // Small delay to ensure rendering is complete before scrolling
            setTimeout(() => {
                 chatbox.scrollTop = chatbox.scrollHeight;
            }, 50); // 50ms delay, adjust if needed
        }

        // Function to render Markdown and apply syntax highlighting
        function renderMarkdownAndHighlight() {
            const modelMessages = document.querySelectorAll('.model-message[data-markdown-content]');

            // Check if libraries are loaded
            if (typeof marked === 'undefined') {
                console.error('marked.js library not loaded.');
                return;
            }
            if (typeof DOMPurify === 'undefined') {
                console.error('DOMPurify library not loaded.');
                return;
            }
             if (typeof hljs === 'undefined') {
                console.error('highlight.js library not loaded.');
                // Decide whether to proceed without highlighting or stop
                // return; // Option: Stop if highlighting is essential
            }


            modelMessages.forEach(element => {
                const rawMarkdown = element.getAttribute('data-markdown-content');
                const initialContentElement = element.querySelector('.raw-model-content');

                try {
                    // 1. Parse Markdown to HTML
                    const dirtyHtml = marked.parse(rawMarkdown);

                    // 2. Sanitize HTML
                    const cleanHtml = DOMPurify.sanitize(dirtyHtml);

                    // 3. Update the element's content after "Gemini:<br>"
                    const breakTag = element.querySelector('br');
                    const containerDiv = document.createElement('div'); // Use a container for the parsed content
                    containerDiv.innerHTML = cleanHtml;

                    // Clear existing raw content (if it exists)
                    if(initialContentElement) {
                        element.removeChild(initialContentElement);
                    }
                    // Clear anything else after the <br> tag (if present)
                    if (breakTag) {
                        while (breakTag.nextSibling) {
                            element.removeChild(breakTag.nextSibling);
                        }
                        // Append the container div after the break tag
                         element.appendChild(containerDiv);
                    } else {
                         // Fallback: Replace entire content if <br> isn't found
                         element.innerHTML = `<b>Gemini:</b><br>`;
                         element.appendChild(containerDiv);
                    }


                    // 4. Apply Syntax Highlighting (if hljs is available)
                    if (typeof hljs !== 'undefined') {
                        // Find all <pre><code> blocks within the newly added content
                        const codeBlocks = containerDiv.querySelectorAll('pre code');
                        codeBlocks.forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }

                } catch (error) {
                    console.error('Error processing Markdown/Highlighting:', error);
                    // If error, ensure the raw text is still displayed reasonably
                    if(initialContentElement) {
                        initialContentElement.style.display = 'inline'; // Make sure raw text is visible
                    }
                }
            });
        }


        // Run functions when the page finishes loading
        window.onload = () => {
            renderMarkdownAndHighlight(); // Render Markdown and highlight code
            scrollToBottom(); // Scroll to bottom after rendering
        };

    </script>
</body>
</html>
